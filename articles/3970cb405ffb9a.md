---
title: "React Router v7 middleware ã‚’ Cloudflare Workers ã§ä½¿ã† (v7.9å®‰å®šåŒ–ç‰ˆ)"
emoji: "ğŸ"
type: "tech"
topics:
  - "cloudflare"
  - "reactrouter"
published: true
published_at: "2025-08-08 17:17"
slug: 3970cb405ffb9a
---

React Router v7 ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ Cloudflare Workers ã§ä½¿ã†æ–¹æ³•ã§ã™ã€‚Cloudflare ç‹¬ç‰¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ (`cloudflare.ctx` ã‚„ `cloudflare.env`) ã‚’å‚ç…§ã•ã›ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã«ã‚‚ãªã£ã¦ã„ã¾ã™ã€‚

ã™ã§ã« React Router v7 ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’åˆ©ç”¨ã—ãŸäº‹ä¾‹ã¯è‰²ã€…ãªæ–¹ãŒæ›¸ã„ã¦ãã ã•ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€v7.8.0 ã§ã®ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚Šã¾ã—ãŸã®ã§ã€å‚™å¿˜éŒ²ã¨ã—ã¦çºã‚ã¾ã—ãŸã€‚

ç ´å£Šçš„å¤‰æ›´ã«é–¢é€£ã™ã‚‹ã®ã¯ã€Œ2. Context Providerã®å®šç¾©ã€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã™ã€‚

:::message
React Router v7 ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ 2025å¹´9æœˆ12æ—¥ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ v7.9.0 ã«ã¦å®‰å®šåŒ–ã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ [Changelog](https://reactrouter.com/changelog) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
:::

:::message
ä»¥ä¸‹ã¯ Cloudflare ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«ã€æ‰‹å…ƒã®ç’°å¢ƒã§ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®å°å…¥ã‚’è¡Œã£ãŸä¸Šã§ã€Claude Code ã«ã‚³ãƒŸãƒƒãƒˆãƒ­ã‚°ã‚’å‚ç…§ã•ã›ã¦è¨˜äº‹ã‚’ãƒ‰ãƒ©ãƒ•ãƒˆã—ãŸå¾Œã€ç´°ã‹ã„éƒ¨åˆ†ã®ã¿ä¿®æ­£ã‚’ã„ã‚Œã¦ã„ã¾ã™ã€‚
:::


#### è£œè¶³

ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ Cloudflare ã®ç’°å¢ƒå¤‰æ•°ã‚„ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«ã€Cloudflare Context ã‚’ä½¿ã†å½¢ã«ãªã£ã¦ã„ã¾ã™ãŒã€Workers ã® `env` ãŠã‚ˆã³ `waitUntil` ã¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’çµŒç”±ã›ãšã¨ã‚‚ "cloudflare:workers" ã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ã§ã™ã€‚RouteContextProvider` çµŒç”±ã§ä½¿ã†ã‚ˆã‚Šã‚‚æ¥½ã ã¨æ€ã„ã¾ã™ã€‚

https://developers.cloudflare.com/changelog/2025-08-08-add-waituntil-cloudflare-workers/

## middleware å°å…¥æ‰‹é †

### 1. è¨­å®šã®è¿½åŠ  (`react-router.config.ts`)

```diff ts
export default {
  ssr: true,
  future: {
    unstable_viteEnvironmentApi: true,
+   v8_middleware: true,
  },
} satisfies Config;
```

`v8_middleware: true`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢æ©Ÿèƒ½ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### 2. Context Providerã®å®šç¾© (`workers/app.ts`)

```diff ts
- import { createRequestHandler } from "react-router";
+ import { createRequestHandler, createContext, RouterContextProvider } from "react-router";

- declare module "react-router" {
-   export interface AppLoadContext {
-     cloudflare: {
-       env: Env;
-       ctx: ExecutionContext;
-     };
-   }
- }
+ export const CloudflareContext = createContext<{
+   cloudflare: {
+     env: Env;
+     ctx: ExecutionContext;
+   };
+ }>();

export default {
  async fetch(request, env, ctx) {
-   return requestHandler(request, {
+   const context = new RouterContextProvider();
+   context.set(CloudflareContext, {
      cloudflare: { env, ctx },
    });
+   return requestHandler(request, context);
  },
} satisfies ExportedHandler<Env>;
```

å¾“æ¥ã® `AppLoadContext` ã‹ã‚‰`RouterContextProvider` ã«å¤‰æ›´ã—ã€Cloudflareã®ç’°å¢ƒæƒ…å ±ã‚’ Context ã¨ã—ã¦è¨­å®šã—ã¾ã™ã€‚

### 3. ãƒ«ãƒ¼ãƒˆã§ã®Middlewareä½¿ç”¨ (`app/routes/home.tsx`)

```diff ts
import type { Route } from "./+types/home";
import { Welcome } from "../welcome/welcome";
+ import { CloudflareContext } from "workers/app";
+ import { createContext } from "react-router";

+ const UserContext = createContext<{ user: { id: string } }>();

+ const authMiddleware: Route.MiddlewareFunction = async ({ request, context }) => {
+   const user = { id: "12345" };
+   context.set(UserContext, { user });
+ }

+ export const middleware: Route.MiddlewareFunction[] = [authMiddleware];

export function loader({ context }: Route.LoaderArgs) {
- return { message: context.cloudflare.env.VALUE_FROM_CLOUDFLARE };
+ const cfContext = context.get(CloudflareContext);
+ const { user } = context.get(UserContext);
+ console.log(`User ID: ${user.id}`)
+ return { message: cfContext.cloudflare.env.VALUE_FROM_CLOUDFLARE };
}
```

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½¿ã‚ãªã„å¾“æ¥ã®å ´åˆã¯ã€Cloudflare ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯ `context.cloudflare` ã¨ã—ã¦å‚ç…§ã§ãã¾ã—ãŸãŒã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã®ã‚ˆã†ã« context.get() ã‚’çµ„ã¿åˆã‚ã›ã¦å‚ç…§ãŒå¿…è¦ã§ã™ã€‚

ã¾ãŸä¸Šè¨˜ã§ã¯ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ `UserContext` ã‚’å®šç¾©ã—ã€`loader()` ã®ä¸­ã§åˆ©ç”¨ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ç¤ºã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸Šã®å†…å®¹ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãŠã„ã¦ãŠãã¾ã™ã€‚

https://github.com/yuheitomi/example-react-router-middleware-cloudflare

## å‚è€ƒ

- https://reactrouter.com/changelog#v790
- https://reactrouter.com/how-to/middleware
